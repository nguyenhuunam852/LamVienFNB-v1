name: Deploy Laravel Inertia as ZIP via FTP

on:
  push:
    branches:
      - production

jobs:
  deploy:

    name: Deploy Laravel ZIP via FTP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'  # Adjust as needed

      - name: Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install JavaScript Dependencies
        run: npm install

      - name: Build Frontend Assets
        run: npm run build

      - name: ðŸ“¡ Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Prepare `laravel_temp` Folder
        run: |
          mkdir -p laravel_temp
          rsync -a --exclude=".env" --exclude="bootstrap/cache" --exclude="public/index.php" --exclude="public/.htaccess" \
            app bootstrap cacert.pem config database public resources/views routes storage vendor artisan composer.json composer.lock laravel_temp/
          cd laravel_temp
          zip -r ../laravel_temp.zip .

      - name: Create delete.php
        run: |
           cat << 'EOF' > delete.php
           <?php
           $folder = '../laravel';
           $excludeFiles = ['.env']; // Modify this array to exclude more files

           function deleteFolder($folder, $excludeFiles = []) {
              if (!is_dir($folder)) {
                  echo "âŒ Error: Folder not found!";
                  exit;
              }

              $files = array_diff(scandir($folder), array('.', '..'));

              foreach ($files as $file) {
                  if (in_array($file, $excludeFiles)) {
                      continue;
                  }

                  $filePath = "$folder/$file";
                  if (is_dir($filePath)) {
                      deleteFolder($filePath, $excludeFiles);
                      rmdir($filePath);
                  } else {
                             unlink($filePath);
                         }
                     }
                 }

                 deleteFolder($folder, $excludeFiles);
                 echo "âœ… Laravel folder cleaned (except " . implode(', ', $excludeFiles) . ")!";

                 $folder = './';
                 $excludeFiles = ['.htaccess', 'index.php'];

                 deleteFolder($folder, $excludeFiles);
                 echo "âœ… public folder cleaned (except " . implode(', ', $excludeFiles) . ")!";

                 if (!unlink(__FILE__)) {
                     echo "âš ï¸ Warning: Failed to delete delete.php!";
                 }
                 ?>
                 EOF

      - name: ðŸš€ Upload Laravel_temp and delete.php
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          lftp -c "
          set ssl:verify-certificate no
          open -u '$FTP_USERNAME','$FTP_PASSWORD' '$FTP_HOST'
          set ftp:sync-mode off
          set net:timeout 10
          set net:max-retries 2
          put -O /domains/firebrick-octopus-777457.hostingersite.com/public_html delete.php
          bye
          "

      - name: ðŸ”¥ Trigger delete.php
        run: curl "https://firebrick-octopus-777457.hostingersite.com/delete.php"

      - name: Create extract.php
        run: |
          cat << 'EOF' > extract.php
          <?php
          $zipFile = '../laravel_temp.zip';
          $extractPath = '../laravel';

          if (!file_exists($zipFile)) {
              die("âŒ Error: Zip file not found!");
          }

          $zip = new ZipArchive;
          if ($zip->open($zipFile) === TRUE) {
              $zip->extractTo($extractPath);
              $zip->close();
              echo "âœ… Extraction complete!<br>";

              function copyFolder($source, $destination) {
                  if (!file_exists($destination)) {
                      mkdir($destination, 0777, true);
                  }

                  foreach (scandir($source) as $file) {
                      if ($file !== '.' && $file !== '..') {
                          $srcFile = "$source/$file";
                          $destFile = "$destination/$file";
                          if (is_dir($srcFile)) {
                              copyFolder($srcFile, $destFile);
                          } else {
                              copy($srcFile, $destFile);
                          }
                      }
                  }
              }

              copyFolder('../laravel/public', './');
              copyFolder('../laravel/views', '../laravel/resources/views');

              $destination = '../laravel/bootstrap/cache';
              if (!file_exists($destination)) {
                  mkdir($destination, 0777, true);
              }

              echo "âœ… Public folder copied to public_html!<br>";

              unlink($zipFile);
              unlink(__FILE__);

              echo "âœ… Cleanup complete!";
          } else {
              echo "âŒ Error: Failed to extract zip file!";
          }
          ?>
          EOF

      - name: ðŸš€ Upload Laravel_temp and extract.php
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          lftp -c "
          set ssl:verify-certificate no
          open -u '$FTP_USERNAME','$FTP_PASSWORD' '$FTP_HOST'
          set ftp:sync-mode off
          set net:timeout 10
          set net:max-retries 2
          put -O /domains/firebrick-octopus-777457.hostingersite.com/public_html extract.php
          put -O /domains/firebrick-octopus-777457.hostingersite.com laravel_temp.zip
          bye
          "

      - name: ðŸ”¥ Trigger extract.php
        run: curl "https://firebrick-octopus-777457.hostingersite.com/extract.php"
